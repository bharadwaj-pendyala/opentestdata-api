from .. import db
from . import User
from .action_type import ActionType


# This is a list of actions together with the type of objects that participate
# in that action.
ACTION_SCHEMAS = [
    (ActionType.SIGNUP, None, None, None),
    (ActionType.CONFIRM_EMAIL, None, None, None),
    (ActionType.UPDATE_USER, User, None, None),
    (ActionType.PROMOTE_USER, User, None, None),
    (ActionType.LIST_USER, User, None, None),
]


def get_schema(type):
    for schema in ACTION_SCHEMAS:
        if schema[0] == type:
            return schema[1:]
    raise Exception(f'Could not find action schema with type {type}')


class Action(db.Model):
    """
    This class doesn't inherit from BaseModel because we don't want an
    updated_at field.

    Each action has one actor (a user), and up to 3 other interacted objects,
    which could be of any type, thus we can't make use of foreign keys for them.
    """

    id = db.Column(db.Integer, primary_key=True)
    created_at = db.Column(db.DateTime(timezone=True),
                           server_default=db.func.now(),
                           nullable=False)
    type = db.Column(db.Enum(ActionType), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    obj1_id = db.Column(db.Integer, default=None)
    obj2_id = db.Column(db.Integer, default=None)
    obj3_id = db.Column(db.Integer, default=None)

    user = db.relationship('User', back_populates='actions', foreign_keys=[user_id])

    def to_obj(self, whos_asking=None):
        res_obj = dict(
            id=self.id,
            created_at=self.created_at,
            type=self.type,
            user=self.user.to_obj(whos_asking=whos_asking)
        )
        schema = get_schema(self.type)
        obj1 = obj2 = obj3 = None
        if schema[0] is not None:
            obj1 = schema[0].query.filter_by(id=self.obj1_id).first().to_obj(whos_asking=whos_asking)
        if schema[1] is not None:
            obj2 = schema[1].query.filter_by(id=self.obj2_id).first().to_obj(whos_asking=whos_asking)
        if schema[2] is not None:
            obj3 = schema[2].query.filter_by(id=self.obj3_id).first().to_obj(whos_asking=whos_asking)
        res_obj['obj1'] = obj1
        res_obj['obj2'] = obj2
        res_obj['obj3'] = obj3
        return res_obj

    @staticmethod
    def create(type, user, *args):
        a = Action(type=type, user=user)
        if len(args) >= 1:
            a.obj1_id = args[0].id
        if len(args) >= 2:
            a.obj2_id = args[1].id
        if len(args) >= 3:
            a.obj3_id = args[2].id
        db.session.add(a)
        db.session.commit()
