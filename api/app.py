from flask import Flask, request, abort
from .config import get_config
from .db import db, migrate
from .db.models.user import User
import connexion

API_VER = '/v1'


def create_app():

    connexionApp = connexion.FlaskApp(__name__, specification_dir='openapi/')
    app = connexionApp.app
    connexionApp.add_api('api.yaml')
    app.config.from_object(get_config())
    db.init_app(app)
    migrate.init_app(app, db, directory='api/db/migrations')

   # @app.route('%s/users/create' % API_VER, methods=['POST'])
    def signup():
        if not request.json:
            abort(400)
        # TODO validate json input
        # TODO check if user details already exist
        u = User(username=request.json['username'], email=request.json['email'])
        u.set_password(request.json['password'])
        db.session.add(u)
        db.session.commit()
        return u.to_json()

    return app

def ping():
    return 'PONG'
