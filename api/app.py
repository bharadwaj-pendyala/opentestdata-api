from .config import get_config
from .db import db, migrate
from .db.models import User, Datum
import connexion

API_VER = '/v1'


def create_app():
    connexionApp = connexion.FlaskApp(__name__, specification_dir='openapi/')
    app = connexionApp.app
    connexionApp.add_api('api.yaml')
    app.config.from_object(get_config())
    db.init_app(app)
    migrate.init_app(app, db, directory='api/db/migrations')
    return app


def ping():
    return 'PONG'


def signup(body):
    # TODO validate json input
    # TODO check if user details already exist
    user = User(username=body.get('username'), email=body.get('email'))
    user.set_password(body.get('password'))
    db.session.add(user)
    db.session.commit()
    return user.to_obj(whos_asking=user)
