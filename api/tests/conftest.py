import os
import pytest
from flask import json
from flask.testing import FlaskClient
from ..app import create_app
from ..db import db


os.environ['FLASK_ENV'] = 'testing'


@pytest.fixture(scope='module')
def client():
    """Fixture to clear and set up the database and init an API client"""

    app = create_app()
    app.test_client_class = JsonRespClient
    with app.test_client() as c:
        with app.app_context():
            db.drop_all()
            db.create_all()
        yield c


class JsonRespClient(FlaskClient):
    """More ergonomic test API client

    Basically traps calls to client.get, client.post, client.delete, and
    turns their JSON responses into actual python values, so we can assert
    based on responses easily. In case of a non-200 response, an exception is
    raised. If this behavior is not desired, pass raw=True.

    We achieve this by overriding the base 'open' method and inspecting the
    response.
    """
    def open(self, *args, **kwargs):
        raw = False
        if 'raw' in kwargs:
            raw = True
            del kwargs['raw']

        resp = super().open(*args, **kwargs)

        if not raw and kwargs['method'] in ['GET', 'POST', 'DELETE']:
            if resp.status != '200 OK':
                raise Exception('Got unexpected %s response for request. '
                                'Body was: "%s"' % (resp.status, resp.data))

            return json.loads(resp.data)

        return resp
